#include <gui/containers/forecastContainer.hpp>
#include "BitmapDatabase.hpp"
#include "texts/TextKeysAndLanguages.hpp"
#include <gui/common/ClockAndDate.hpp>

#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#ifdef SIMULATOR
#include <time.h>
//#include <chrono>
#endif // SIMULATOR


forecastContainer::forecastContainer()
{

}

void forecastContainer::initialize()
{
    forecastContainerBase::initialize();
}

void forecastContainer::update(char *icon, char *weekday, int temperature, int windspeed, bool metric)
{
    updateIcon(icon);
    updateWeekday(weekday);
    updateTemperature(temperature);
    updateWindspeed(windspeed, metric);
}

void forecastContainer::updateIcon(char* icon)
{
   char temp[2];
   memcpy(temp, icon, 2);
   int x = atoi(temp);

   if (icon[2] == 'd')
   {
       switch (x)
       {
       case 1:
           weatherIcon.setBitmap(Bitmap(BITMAP_ICON_48_CLEAR_SKY_ID));
           break;

       case 2:
           weatherIcon.setBitmap(Bitmap(BITMAP_ICON_48_FEW_CLOUDS_ID));
           break;

       case 3:
           weatherIcon.setBitmap(Bitmap(BITMAP_ICON_48_SCATTERED_CLOUDS_ID));
           break;

       case 4:
           weatherIcon.setBitmap(Bitmap(BITMAP_ICON_48_BROKEN_CLOUDS_ID));
           break;

       case 9:
       case 10:
           weatherIcon.setBitmap(Bitmap(BITMAP_ICON_48_RAIN_ID));
           break;

       case 11:
           weatherIcon.setBitmap(Bitmap(BITMAP_ICON_48_THUNDER_ID));
           break;

       case 13:
           weatherIcon.setBitmap(Bitmap(BITMAP_ICON_48_SNOW_ID));
           break;

       case 50:
           weatherIcon.setBitmap(Bitmap(BITMAP_ICON_48_MIST_ID));
           break;

       default:
           break;
       }
   } 
   else
   {
       switch (x)
       {
       case 1:
           weatherIcon.setBitmap(Bitmap(BITMAP_ICON_48_CLEAR_SKY_NIGHT_ID));
           break;

       case 2:
           weatherIcon.setBitmap(Bitmap(BITMAP_ICON_48_FEW_CLOUDS_NIGHT_ID));
           break;

       case 3:
           weatherIcon.setBitmap(Bitmap(BITMAP_ICON_48_SCATTERED_CLOUDS_NIGHT_ID));
           break;

       case 4:
           weatherIcon.setBitmap(Bitmap(BITMAP_ICON_48_BROKEN_CLOUDS_NIGHT_ID));
           break;

       case 9:
       case 10:
           weatherIcon.setBitmap(Bitmap(BITMAP_ICON_48_RAIN_NIGHT_ID));
           break;

       case 11:
           weatherIcon.setBitmap(Bitmap(BITMAP_ICON_48_THUNDER_NIGHT_ID));
           break;

       case 13:
           weatherIcon.setBitmap(Bitmap(BITMAP_ICON_48_SNOW_NIGHT_ID));
           break;

       case 50:
           weatherIcon.setBitmap(Bitmap(BITMAP_ICON_48_MIST_NIGHT_ID));
           break;

       default:
           break;
       }
   }
   weatherIcon.invalidate();
}

void forecastContainer::updateWeekday(char* date)
{
    int year, month, day;

    char temp[4];

    memcpy(temp, &date[0], 4);
    year = atoi(temp);

    memcpy(temp, &date[5], 2);
    temp[2] = '\0';
    month = atoi(temp);

    memcpy(temp, &date[8], 2);
    day = atoi(temp);

    switch (getWeekday(year, month, day))
    {
    case 0:
        weekday.setTypedText(TypedText(T_FORECASTSUNDAY));
        break;
    case 1:
        weekday.setTypedText(TypedText(T_FORECASTMONDAY));
        break;
    case 2:
        weekday.setTypedText(TypedText(T_FORECASTTUESDAY));
        break;
    case 3:
        weekday.setTypedText(TypedText(T_FORECASTWEDENSDAY));
        break;
    case 4:
        weekday.setTypedText(TypedText(T_FORECASTTHURSDAY));
        break;
    case 5:
        weekday.setTypedText(TypedText(T_FORECASTFRIDAY));
        break;
    case 6:
        weekday.setTypedText(TypedText(T_FORECASTSATURDAY));
        break;
    }

    weekday.invalidate();
}

void forecastContainer::updateTemperature(int temperature)
{
    Unicode::snprintf(tempBuffer, TEMP_SIZE, "%d", temperature);    
    temp.invalidate();
}

void forecastContainer::updateWindspeed(int speed, bool metric)
{
    if (metric)
    {
        wind.setTypedText(touchgfx::TypedText(T_WINDMETRIC));
    }
    else
    {
        wind.setTypedText(touchgfx::TypedText(T_WINDIMPERIAL));
    }

    Unicode::snprintf(windBuffer, WIND_SIZE, "%d", speed);
    wind.invalidate();
}

void forecastContainer::setAlpha(uint8_t alpha)
{
    wind.setAlpha(alpha);
    temp.setAlpha(alpha);
    weekday.setAlpha(alpha);
    weatherIcon.setAlpha(alpha);
}

uint8_t forecastContainer::getAlpha()
{
    return weatherIcon.getAlpha();
}
